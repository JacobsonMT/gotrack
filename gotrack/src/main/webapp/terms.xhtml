<ui:composition template="/WEB-INF/templates/mainLayout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
>

    <ui:define name="metadata">
        <f:metadata>
            <f:viewParam id="query" name="query" value="#{termView.query}"/>
            <f:event type="preRenderView" listener="#{termView.init}"/>
        </f:metadata>
    </ui:define>
    <ui:define name="pageTitle">GOtrack</ui:define>
    <ui:define name="css">
        <h:outputStylesheet library="css" name="term.css"/>
        <h:outputStylesheet library="css" name="gograph.css"/>
        <h:outputStylesheet library="css" name="tipsy.css"/>
    </ui:define>
    <ui:define name="js">
        <script type="text/javascript">
            googleAnalyticsTrackPageviewIfConfigured("/gotrack/terms");
        </script>
        <h:outputScript library="js" name="utility.js"/>


        <!-- Highcharts stuff -->
        <ui:include src="/WEB-INF/includes/highcharts-js.xhtml" />

        <h:outputScript library="js" name="tipsy.js"/>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <h:outputScript library="js" name="dagre-d3.min.js"/>


        <h:outputScript library="js" name="plotting.js"/>
        <h:outputScript library="js" name="gograph.js"/>
        <h:outputScript library="js" name="term.js"/>

        <h:outputScript rendered="#{termView.trackedTerms != null}">
            $(document).ready(function () {
            $('.loading').show();
            fetchDAGData();
            fetchEvidenceChart();
            fetchOverviewChart();
            fetchGeneChart();

            });
        </h:outputScript>
    </ui:define>

    <ui:define name="left_right_layout">

    </ui:define>

    <ui:define name="center_layout">
        <p:outputPanel rendered="#{termView.trackedTerms != null}">
            <div id="page-title">
                <h1>#{termView.currentTerm.goId} - #{termView.currentTerm.name}</h1>
                <h:form>
                    <p>#{termView.currentTerm.aspect.label}</p>
                </h:form>

            </div>
            <p:separator style="max-width:400px"/>
            <h:form id="centerTabViewForm" style="margin:0 25px 0 25px;">
                <p:remoteCommand name="fetchDAGData" async="true"
                                 oncomplete="handleFetchDAGData(xhr, status, args);"
                                 actionListener="#{termView.fetchDAGData()}"/>
                <p:remoteCommand name="fetchOverviewChart" async="true"
                                 oncomplete="handleFetchOverviewChart(xhr, status, args);"
                                 actionListener="#{termView.fetchOverviewChart()}"/>
                <p:remoteCommand name="fetchGeneChart" async="true"
                                 oncomplete="handleFetchGeneChart(xhr, status, args);"
                                 actionListener="#{termView.fetchGeneChart()}"/>
                <p:remoteCommand name="fetchEvidenceChart" async="true"
                                 oncomplete="handleFetchEvidenceChart(xhr, status, args);"
                                 actionListener="#{termView.fetchEvidenceChart()}"/>
                <p:remoteCommand name="fetchGraph"
                                 oncomplete="PF('graphDlgWdg').show();handleFetchGraphDialog(xhr, status, args);"
                                 actionListener="#{termView.fetchGraph()}"/>
                <p:tabView id="centerTabView" widgetVar="centerTabWdg" onTabShow="tabShowed(index)">
                    <p:tab>
                        <f:facet name='title'>
                            <h:outputText value="Term Information "/>
                            <p:commandButton id="termInfoTabHelpBtn" value=""
                                             styleClass="no-value no-background fa-fix" icon="fa fa-question-circle"
                                             title="Help"
                                             type="button"/>
                        </f:facet>
                        <p:outputPanel>
                            <p:panelGrid styleClass="no-border">
                                <p:row>
                                    <p:column>
                                        <h:outputText value="ID"/>
                                    </p:column>
                                    <p:column>
                                        <h:outputText value="#{termView.currentTerm.goId}"
                                                      styleClass="sqlDialogText"/>
                                    </p:column>
                                </p:row>
                                <p:row>
                                    <p:column>
                                        <h:outputText value="Aspect"/>
                                    </p:column>
                                    <p:column>
                                        <h:outputText value="#{termView.currentTerm.aspect.label}"
                                                      styleClass="sqlDialogText"/>
                                    </p:column>
                                </p:row>
                                <p:row>
                                    <p:column>
                                        <h:outputText value="Name"/>
                                    </p:column>
                                    <p:column>
                                        <h:outputText value="#{termView.currentTerm.name}"
                                                      styleClass="sqlDialogText"/>
                                    </p:column>
                                </p:row>
                                <p:row>
                                    <p:column style="vertical-align: top">
                                        <h:outputText value="Definition"/>
                                    </p:column>
                                    <p:column>
                                        <h:outputText value="#{termView.definition}"
                                                      styleClass="sqlDialogText"/>
                                    </p:column>
                                </p:row>
                            </p:panelGrid>
                            <h3>Ancestry Chart</h3>
                            <div id="loading-spinner-DAG" class="loading"
                                 style="display: none;"/>
                            <svg id="currentAncestry" width="900" height="600"/>
                        </p:outputPanel>
                    </p:tab>
                    <p:tab>
                        <f:facet name='title'>
                            <h:outputText value="Child Terms "/>
                            <p:commandButton id="childTabHelpBtn" value=""
                                             styleClass="no-value no-background fa-fix" icon="fa fa-question-circle"
                                             title="Help"
                                             type="button"/>
                        </f:facet>
                        <p:outputPanel>
                            <p:dataTable var="child" value="#{termView.currentTerm.children}"
                                         styleClass="child-table">
                                <p:column headerText="Relationship" width="100px">
                                    <h:outputText value="#{child.type}"/>
                                </p:column>

                                <p:column headerText="Term" width="100px">
                                    <p:link value="#{child.relation.goId}" outcome="terms"
                                            target="_blank">
                                        <f:param name="query" value="#{child.relation.goId}"/>
                                    </p:link>
                                </p:column>

                                <p:column headerText="Name">
                                    <h:outputText value="#{child.relation.name}"/>
                                </p:column>
                            </p:dataTable>
                        </p:outputPanel>
                    </p:tab>
                    <p:tab>
                        <f:facet name='title'>
                            <h:outputText value="History "/>
                            <p:commandButton id="historyTabHelpBtn" value=""
                                             styleClass="no-value no-background fa-fix" icon="fa fa-question-circle"
                                             title="Help"
                                             type="button"/>
                        </f:facet>
                        <p:outputPanel>
                            <div id="loading-spinner-overview" class="loading"
                                 style="display: none;"/>
                            <div id="hc_overview_container"
                                 style="width: 100%; height: 600px;"/>

                        </p:outputPanel>
                    </p:tab>
                    <p:tab>
                        <f:facet name='title'>
                            <h:outputText value="Gene Breakdown "/>
                            <p:commandButton id="geneTabHelpBtn" value=""
                                             styleClass="no-value no-background fa-fix" icon="fa fa-question-circle"
                                             title="Help"
                                             type="button"/>
                        </f:facet>
                        <div id="loading-spinner-gene" class="loading"
                             style="display: none;"/>
                        <div id="hc_gene_container" style="width: 100%; height: 600px;"/>

                    </p:tab>
                    <p:tab>
                        <f:facet name='title'>
                            <h:outputText value="Evidence Breakdown "/>
                            <p:commandButton id="evidenceTabHelpBtn" value=""
                                             styleClass="no-value no-background fa-fix" icon="fa fa-question-circle"
                                             title="Help"
                                             type="button"/>
                        </f:facet>
                        <div id="loading-spinner-evidence" class="loading"
                             style="display: none;"/>
                        <div id="hc_evidence_container"
                             style="width: 100%; height: 600px;"/>

                    </p:tab>
                </p:tabView>

            </h:form>
        </p:outputPanel>

        <p:outputPanel rendered="#{termView.trackedTerms == null}">
            <h:form>
                <h3 style="text-align: center;">Track a Term</h3>
                <p:panelGrid style="margin-bottom:10px" cellpadding="5"
                             styleClass="termSearchTable no-border">
                    <p:row>
                        <p:column>
                            <h:outputText value="Enter a GO Term ID or Name: "/>
                        </p:column>
                        <p:column>
                            <p:autoComplete value="#{termSearchView.query}"
                                            completeMethod="#{termSearchView.complete}" queryDelay="600"
                                            minQueryLength="2" forceSelection="true" maxResults="10"
                                            label="ID" panelStyleClass="autocomplete-largepanel"
                                            emptyMessage="No term suggestions available, please try again."
                                            var="term" itemLabel="#{term.goId}" itemValue="#{term.goId}">
                                <p:column>
                                    <h:outputText value="#{term.goId} - #{term.name}"/>
                                </p:column>
                            </p:autoComplete>
                        </p:column>
                    </p:row>
                    <p:row>
                        <p:column colspan="2">
                            <p:commandButton type="submit" value="Go"
                                             action="#{termSearchView.go}"/>
                        </p:column>
                    </p:row>
                </p:panelGrid>
            </h:form>

        </p:outputPanel>

    </ui:define>
    <ui:define name="dialogs">
        <p:dialog id="graphDlg" header="Ancestor Chart"
                  widgetVar="graphDlgWdg" modal="false" showEffect="fade"
                  hideEffect="fade" resizable="false" height="600px;" width="800px;">
            <svg id="dagDialog" height="500" width="700"/>
        </p:dialog>

        <p:overlayPanel for=":centerTabViewForm:centerTabView:termInfoTabHelpBtn" hideEffect="fade"
                        style="width:600px;text-align:left;">
            <p>The <b>Term Information</b> tab shows the most current information for the selected GO term.</p>
            <p>
                <b>Ancestry Chart:</b> The most current ancestry chart for the selected GO term. The figure is interactive:
                <i>select</i> a term to open its individual page,
                <i>hover</i> a term to view more information and highlight its direct relations, <i>zoom</i>, and
                <i>pan</i>.</p>
            <ul>
                <li><i>Selecting</i> a term will open its individual page.</li>
                <li>
                    <i>Hovering</i> a term show more information as well as both highlight its direct relations and fade those terms which are not in its path to Root.
                </li>
                <li><i>Zoom</i> using mouse wheel.</li>
                <li><i>Pan</i> by click and drag.</li>
            </ul>
        </p:overlayPanel>

        <p:overlayPanel for=":centerTabViewForm:centerTabView:childTabHelpBtn" hideEffect="fade"
                        style="width:600px;text-align:left;">
            <p>The <b>Child Terms</b> tab shows children of the selected term from the most current edition.</p>
        </p:overlayPanel>

        <p:overlayPanel for=":centerTabViewForm:centerTabView:historyTabHelpBtn" hideEffect="fade"
                        style="width:600px;text-align:left;">
            <p>The <b>History</b> tab shows three metrics about the selected GO term:</p>
            <ul>
                <li><b>Existence:</b> Displays green when the term existed and red when it did not.
                    <i>Clicking</i> a bar will show the ancestry chart at that point in history.
                </li>
                <li>
                    <b>Structure Change:</b> Displays as green when the ancestry chart changed from the previous GO edition.
                    <i>Clicking</i> a bar will show the ancestry chart at that point in history overlayed with the changes from the previous edition:
                    <ul>
                        <li>Green nodes and dashed green edges were newly created.</li>
                        <li>Red nodes and dashed red edges were removed.</li>
                    </ul>
                </li>
                <li><b>Name Change:</b> Displays as green when the name of this term changed.
                    <i>Hovering</i> a bar will show the name change.
                </li>
            </ul>
        </p:overlayPanel>

        <p:overlayPanel for=":centerTabViewForm:centerTabView:geneTabHelpBtn" hideEffect="fade"
                        style="width:600px;text-align:left;">
            <p>The
                <b>Gene Breakdown</b> tab shows per species counts of distinct genes that have been annotated with this GO term over its history.
            </p>
            <p>
                <b>Direct vs Not:</b> Direct measures look only at those genes which have been directly annotated with this term. Non-direct series (inferred) also counts genes which have been annotated with a child of this term.
            </p>
            <p>
                <i>Clicking</i> the Subset button on top of the legend will toggle between important subsets of series. Namely: Direct, Indirect, and All.
            </p>
        </p:overlayPanel>

        <p:overlayPanel for=":centerTabViewForm:centerTabView:evidenceTabHelpBtn" hideEffect="fade"
                        style="width:600px;text-align:left;">
            <p>The <b>Evidence Breakdown</b> tab shows per evidence category counts of annotations made with this term.
            </p>
            <p>See the following for an explanation of Evidence Codes:</p>
            <p:lightBox>
                <h:outputLink value="/gotrack/javax.faces.resource/diag-evCodeFlowChartGood.png?ln=img"
                              title="Evidence Code Flow Chart">
                    <h:graphicImage library="img" width="100" height="56" name="diag-evCodeFlowChartGood.png"/>
                </h:outputLink>
            </p:lightBox>
        </p:overlayPanel>

    </ui:define>

</ui:composition>