<ui:composition template="/WEB-INF/templates/mainLayout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:of="http://omnifaces.org/functions">

	<ui:define name="metadata">
		<f:metadata>
			<f:viewParam id="speciesId" name="speciesId"
				value="#{trackView.speciesId}" />
			<f:viewParam id="query" name="query" value="#{trackView.query}" />
			<f:event type="preRenderView" listener="#{trackView.init}" />
		</f:metadata>
	</ui:define>
	<ui:define name="pageTitle">UBC-CHiBi|GOtrack</ui:define>
	<ui:define name="css">
		<h:outputStylesheet library="css" name="track.css" />
	</ui:define>
	<ui:define name="js">
		<h:outputScript library="js" name="utility.js" />
		<h:outputScript library="js" name="gotrack.js" />
		<h:outputScript library="js" name="chartExtendedFunctionality.js" />
		<h:outputScript library="js" name="jqplot.logAxisRenderer.js" />
		<h:outputScript rendered="#{trackView.currentGene != null}">$(document).ready(function() {
		$('#loading-spinner').show();
		fetchCharts();
		});</h:outputScript>
		   
   
	</ui:define>

	<ui:define name="left_right_layout">

		<p:layoutUnit id="left" position="west" size="275" resizable="true"
			collapsible="true" header="Options" minSize="275" collapsed="#{trackView.currentGene == null}">
			<h:form id="leftForm">
				<h3 class="center">Graph</h3>
				<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
					<h:outputText value="Type: " />
					<p:selectOneMenu value="#{trackView.graphType}"
						disabled="#{!(trackView.chartsReady)}">
						<p:ajax listener="#{trackView.reloadGraph}"
							update=":chartForm:chart1,:leftForm"
							oncomplete="postRenderChart(args);" />
						<f:selectItem itemLabel="Annotation" itemValue="annotation" />
						<f:selectItem itemLabel="Jaccard" itemValue="jaccard" />
						<f:selectItem itemLabel="Multifunctionality"
							itemValue="multifunctionality" />
						<f:selectItem itemLabel="Loss / Gain" itemValue="lossgain" />
					</p:selectOneMenu>


				</h:panelGrid>
				<p:separator style="max-width:200px" />
				<h3 class="center">Data</h3>
				<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
					<h:outputText value="Propagate Annotations: " />
					<p:inputSwitch value="#{trackView.propagate}"
						disabled="#{!(trackView.chartsReady) || !(trackView.dataEnabled)}">
						<p:ajax listener="#{trackView.reloadGraph}"
							update=":chartForm:chart1" oncomplete="postRenderChart(args);" />
					</p:inputSwitch>

					<h:outputText value="Split Accessions: " />
					<p:inputSwitch value="#{trackView.splitAccessions}"
						disabled="#{!(trackView.chartsReady) || !(trackView.dataEnabled)}">
						<p:ajax listener="#{trackView.reloadGraph}"
							update=":chartForm:chart1" oncomplete="postRenderChart(args);" />
					</p:inputSwitch>

				</h:panelGrid>
				<p:separator style="max-width:200px" />
				<h3 class="center">Display</h3>
				<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
					<h:outputText value="Scale: " />
					<p:selectOneButton id="scaleSelect" value="#{trackView.scale}"
						onchange="changeGraphScale()"
						disabled="#{!(trackView.chartsReady)}">
						<f:selectItem itemLabel="Linear" itemValue="linear" />
						<f:selectItem itemLabel="Log" itemValue="log" />
					</p:selectOneButton>


				</h:panelGrid>

				<p:separator style="max-width:200px" />
				<h3 class="center">
					Filter
					<p:commandButton actionListener="#{trackView.clearOptionFilters()}"
						icon="fa fa-trash" update=":chartForm:chart1, :leftForm"
						oncomplete="changeGraphScale()" styleClass="icon-only"
						disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}" />
				</h3>
				<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">

					<h:outputText value="Dataset: " />
					<p:selectManyButton value="#{trackView.filterDataset}"
						disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}"
						converter="datasetConverter">
						<p:ajax listener="#{trackView.reloadGraph}"
							update=":chartForm:allCharts" oncomplete="postRenderChart(args);" />
						<f:selectItems value="#{cache.datasets}" var="dataset"
							itemValue="#{dataset}" itemLabel="#{dataset.label}" />

					</p:selectManyButton>

					<p:separator style="max-width:50px" />
					<p:separator style="max-width:50px" />

					<h:outputText value="Aspect: " />
					<p:selectManyButton id="optionFilterAspect"
						value="#{trackView.filterAspect}"
						disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}">
						<p:ajax listener="#{trackView.reloadGraph}"
							update=":chartForm:chart1" oncomplete="postRenderChart(args);" />
						<f:selectItem itemLabel="BP" itemValue="BP" />
						<f:selectItem itemLabel="MF" itemValue="MF" />
						<f:selectItem itemLabel="CC" itemValue="CC" />

					</p:selectManyButton>

					<h:outputText value="Id: " />
					<p:autoComplete id="optionFilterId" value="#{trackView.filterId}"
						completeMethod="#{trackView.completeId}" queryDelay="600"
						minQueryLength="1" forceSelection="true" maxResults="10"
						label="ID" emptyMessage="No term suggestions available."
						disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}">
						<p:ajax event="itemSelect" listener="#{trackView.reloadGraph}"
							update=":chartForm:chart1" oncomplete="postRenderChart(args);" />
					</p:autoComplete>

					<h:outputText value="Name: " />
					<p:inputText id="optionFilterName" value="#{trackView.filterName}"
						disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}">
						<p:ajax event="change" listener="#{trackView.reloadGraph}"
							update=":chartForm:chart1" oncomplete="postRenderChart(args);" />
					</p:inputText>


				</h:panelGrid>

				<p:separator style="max-width:200px; height:5px;" />
				<div align="center" style="margin-top: 20px;">
					<p:commandButton value="&#160; Reset" onclick="showAllSeries()"
						type="button" icon="fa fa-refresh" disabled="#{trackView.currentGene == null}"/>
				</div>
			</h:form>


			<f:facet name="footer">
				<h:graphicImage library="img" width="130" height="110"
					name="logo1.png" styleClass="center" />
			</f:facet>
		</p:layoutUnit>

		<p:layoutUnit id="right" position="east" size="550" minSize="300"
			header="Functionality" resizable="true" collapsible="true"
			style="text-align:center" collapsed="#{trackView.currentGene == null}">
			<h:form id="funcForm" style="height:100%;">
				<p:dataTable id="funcTable" widgetVar="funcTable" var="term"
					value="#{trackView.allTerms}" scrollable="true" sortMode="multiple"
					style="margin-bottom:0"
					emptyMessage="No annotations found with given criteria"
					filteredValue="#{trackView.filteredAllTerms}"
					selectionMode="multiple" selection="#{trackView.selectedTerms}"
					rowKey="#{term.goId}" scrollHeight="100%"
					rowStyleClass="#{ term.obsolete == 'true' ? 'datatable-red' : null}">
					<p:column filterBy="#{term.goId}" filterMatchMode="contains"
						headerText="Id" width="25%">
						<a href="http://www.ebi.ac.uk/QuickGO/GTerm?id=#{term.goId}"
							target="_blank"><i class="fa fa-external-link fa-sm"
							style="font-size: 0.7em;" /> #{term.goId}</a>
					</p:column>
					<p:column filterBy="#{term.aspect}" filterMatchMode="in"
						headerText="Aspect" width="20%">
						<f:facet name="filter">
							<p:selectCheckboxMenu label="Aspect"
								onchange="PF('funcTable').filter()"
								panelStyleClass="without-selectall">
								<f:selectItems value="#{trackView.aspects}" />
							</p:selectCheckboxMenu>
						</f:facet>
						<h:outputText value="#{term.aspect}" />
					</p:column>
					<p:column filterBy="#{term.name}" filterMatchMode="contains"
						headerText="Name" width="55%">
						<h:outputText value="#{term.name}" />
					</p:column>
					<f:facet name="footer">
						<p:commandButton process="funcTable" icon="ui-icon-search"
							value="View" onclick="fetchTimelineFromPanel()"
							oncomplete="PF('timelineDialog').show()" />
					</f:facet>
				</p:dataTable>

				<p:remoteCommand
					actionListener="#{trackView.fetchTimelineFromPanel()}"
					name="fetchTimelineFromPanel" update=":timelineForm">
				</p:remoteCommand>

			</h:form>
		</p:layoutUnit>
	</ui:define>

	<ui:define name="center_layout">
		<p:outputPanel rendered="#{trackView.currentGene != null}">
			<div id="page-title">
				<h1>#{trackView.currentGene.symbol} -
					#{trackView.currentSpecies.scientificName}</h1>
				<h:form>
					<p>
						<ui:repeat
							value="#{trackView.getCurrentPrimaryAccessionsValues()}"
							var="acc" varStatus="loop">
							<a href="http://www.uniprot.org/uniprot/#{acc.accession}"
								target="_blank">#{acc.accession}</a>#{!loop.last ? ', ' : ''}
				</ui:repeat>
					</p>
				</h:form>
			</div>
			<p:separator style="max-width:400px" />

			<h:form id="chartForm" style="margin:0 25px 0 25px;">
				<p:outputPanel id="allCharts">
					<div id="loading-spinner" class="loading" style="display: none;" />
					<p:chart id='chart1' type="line" model="#{trackView.currentChart}"
						style="height:500px;" widgetVar="chart"
						rendered="#{trackView.chartsReady and !(trackView.chartEmpty) }">
						<p:ajax event="itemSelect" listener="#{trackView.itemSelect}"
							oncomplete="openAnnotationDialog()" />
					</p:chart>
				</p:outputPanel>
				<p:remoteCommand name="fetchCharts"
					actionListener="#{trackView.fetchAll()}"
					update="allCharts,:leftForm,:funcForm:funcTable"
					oncomplete="hideLoadingSpinner()">
				</p:remoteCommand>
				<p:remoteCommand oncomplete="PF('itemSelectDialog').show();"
					update=":itemSelectForm:itemSelectMsg,:itemSelectForm:itemSelectData"
					name="openAnnotationDialog" />


				<!-- PUT THE ACTUAL CONTENT -->

				<!-- End of the FUNCTIONALITY CONTENT -->
			</h:form>
		</p:outputPanel>
		<p:outputPanel rendered="#{trackView.currentGene == null}">
			<h:form>
				<h3 style="text-align: center;">Track a Gene</h3>
				<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5" styleClass="geneSearchTable">

					<h:outputText value="Select the species of interest (required): " />
				<p:selectOneMenu id="selectspecies"
					value="#{geneSearchView.speciesId}" style="margin-right:5px;">
					<p:ajax event="change" process="@this" />
					<f:selectItems value="#{cache.speciesList}" var="spec"
						itemValue="#{spec.id}" itemLabel="#{spec.commonName}" />
				</p:selectOneMenu>
				<h:outputText value="Write the gene symbol to visualize: " />
				<p:autoComplete id="geneInput" value="#{geneSearchView.query}"
					completeMethod="#{geneSearchView.complete}" queryDelay="600"
					minQueryLength="2" forceSelection="true" maxResults="10" label="ID"
					emptyMessage="No gene suggestions available, please try again."
					style="margin-right:8px;" />
				<p:commandButton type="submit" value="Go"
					action="#{geneSearchView.go}" />
					</h:panelGrid>
			</h:form>
			
		</p:outputPanel>
	</ui:define>
	<ui:define name="dialogs">

		<p:dialog id="timelineDialog" header="Selected Terms"
			widgetVar="timelineDialog" modal="true" showEffect="fade"
			hideEffect="fade" resizable="false" width="800" max-height="600"
			style="text-align:center;" onHide="cleanMsg()"
			onShow="setTimelineInitialRange()">
			<p:ajax event="close" listener="#{trackView.cleanTimeline}"
				update=":timelineForm" />
			<p:scrollPanel id="timeline-scrollpanel" mode="native"
				style="max-height:500px">
				<h:outputText id="timelineSelectMsgDate" />
				<p:spacer width="30" height="16" />
				<h:outputText id="timelineSelectMsgTerm" />
				<p:spacer width="30" height="16" />
				<h:outputText id="timelineSelectMsgReference" />


				<h:form id="timelineForm">
					<p:dataGrid id="timelineDataGrid" var="tl"
						value="#{trackView.timelines}" columns="1" style="border:none;"
						rowIndexVar="rowIndex" widgetVar="timelineDataGridWidget">
						<p:panel style="text-align:center">
							<f:facet name="header">
								<h:outputText
									value="#{tl.title.goId} - #{of:abbreviate(tl.title.name, 50)}"
									title="#{tl.title.name}" />
							</f:facet>
							<pe:timeline id="timeline-#{rowIndex}"
								widgetVar="timelineWidget-#{rowIndex}" value="#{tl}"
								varGroup="group" selectable="true" eventMargin="10"
								eventMarginAxis="0" stackEvents="false" themable="false"
								showCurrentTime="false" groupsWidth="125px">
								<pe:javascript event="select"
									execute="timelineSelect('#{rowIndex}')" />
								<pe:javascript event="rangechange"
									execute="onTimelineRangeChange('#{rowIndex}')" />

							</pe:timeline>
						</p:panel>
					</p:dataGrid>
				</h:form>
				<pe:tooltip global="true" myPosition="center left"
					atPosition="top right" />
			</p:scrollPanel>
		</p:dialog>
		<p:dialog id="itemSelectDialog" header="Annotations"
			widgetVar="itemSelectDialog" modal="false" width="700px">
			<p:ajax event="close" listener="#{trackView.cleanFilteredTerms}"
				update=":itemSelectForm:itemSelectData" />
			<h:form id="itemSelectForm">
				<h:outputText id="itemSelectMsg"
					value="Date: #{trackView.selectedDate}, Count: #{trackView.itemSelectValue}" />
				<p:dataTable id="itemSelectData" widgetVar="annotationsTable"
					var="chartTerm" value="#{trackView.itemSelectTerms}"
					scrollable="true" scrollHeight="250" sortMode="multiple"
					style="margin-bottom:0"
					emptyMessage="No annotations found with given criteria"
					filteredValue="#{trackView.filteredTerms}" selectionMode="multiple"
					selection="#{trackView.itemSelectViewTerms}"
					rowKey="#{chartTerm.goId}"
					rowStyleClass="#{ chartTerm.obsolete == 'true' ? 'datatable-red' : null}">
					<p:column filterBy="#{chartTerm.goId}" filterMatchMode="contains"
						headerText="Id" style="width:120px;">
						<a href="http://www.ebi.ac.uk/QuickGO/GTerm?id=#{chartTerm.goId}"
							target="_blank"><i class="fa fa-external-link fa-sm"
							style="font-size: 0.7em;" /> #{chartTerm.goId}</a>
					</p:column>
					<p:column filterBy="#{chartTerm.aspect}" filterMatchMode="in"
						headerText="Aspect" style="width:200px;">
						<f:facet name="filter">
							<p:selectManyButton onchange="PF('annotationsTable').filter()"
								panelStyle="width:200px">
								<f:selectItem itemLabel="BP" itemValue="BP" />
								<f:selectItem itemLabel="MF" itemValue="MF" />
								<f:selectItem itemLabel="CC" itemValue="CC" />
							</p:selectManyButton>
						</f:facet>
						<h:outputText value="Biological Process"
							rendered="#{chartTerm.aspect == 'BP'}" />
						<h:outputText value="Molecular Function"
							rendered="#{chartTerm.aspect == 'MF'}" />
						<h:outputText value="Cellular Component"
							rendered="#{chartTerm.aspect == 'CC'}" />
					</p:column>
					<p:column filterBy="#{chartTerm.name}" filterMatchMode="contains"
						headerText="Name">
						<h:outputText value="#{chartTerm.name}" />
					</p:column>
					<f:facet name="footer">
						<p:commandButton process="itemSelectData" icon="ui-icon-search"
							value="View" onclick="fetchTimelineFromDialog()"
							oncomplete="PF('timelineDialog').show()" />
					</f:facet>
				</p:dataTable>
				<p:remoteCommand
					actionListener="#{trackView.fetchTimelineFromDialog()}"
					name="fetchTimelineFromDialog" update=":timelineForm">
				</p:remoteCommand>
			</h:form>
		</p:dialog>
	</ui:define>

</ui:composition>