<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:of="http://omnifaces.org/functions">

<f:view contentType="text/html">
	<f:metadata>
		<f:viewParam id="currentSpeciesId" name="currentSpeciesId"
			value="#{trackView.currentSpeciesId}" />
		<f:viewParam id="query" name="query" value="#{trackView.query}" />
		<f:event type="preRenderView" listener="#{trackView.init}" />
	</f:metadata>
	<h:head>
		<title>UBC-CHiBi|GOtrack</title>
		<h:outputStylesheet
			name="webjars/font-awesome/4.2.0/css/font-awesome.css" />
		<h:outputStylesheet library="css" name="showcase.css" />
		<h:outputStylesheet library="css" name="custom.css" />
		<h:outputStylesheet library="css" name="track.css" />

		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<!-- Prevents caching at the Proxy Server -->

		<meta http-equiv="Expires" content="0" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="description"
			content="GOtrack is an integral tool that reflects the problems and trends in the stability and annotation biases of multiple model organisms." />

		<meta name="keywords"
			content="genomics,bioinformatics,genetics,gene,function,ontology,biotechnology,medicine,biomedical,meta-analysis,statistics,search,open source,database,software" />
		
		<h:outputScript library="js" name="utility.js" />
		<h:outputScript library="js" name="gotrack.js" />
		<h:outputScript library="js" name="jqplot.logAxisRenderer.js" />
		
		<script>
		//$.jqplot.postDrawHooks.push(function() {console.log('thjsiasfjnad od')});
      function chartExtender() {
         // this = chart widget instance        
         // this.cfg = options 
         this.cfg.legend = {
            renderer : $.jqplot.EnhancedLegendRenderer,
            show : true,
            location : 's',
            placement : 'outsideGrid',
            rendererOptions : {
               numberRows : 0,
               numberColumns : 10,
               seriesToggle: true,
               seriesToggleReplot : {resetAxes: true}
            }
         }
         this.cfg.highlighter = {
            show : true,
            tooltipLocation : 'sw',
            useAxesFormatters : true,
            tooltipAxes : 'xy',
            yvalues : 1,
            formatString : 'Date: %s ~ Count: %s',
            tooltipContentEditor : function(str, seriesIndex, pointIndex, plot) {
               return plot.series[seriesIndex].label + ": " + str;
            },
            bringSeriesToFront : true

         }
         //console.log(this.cfg.axes);
         //this.cfg.axes.yaxis.label = "Per Capita Expenditure (local currency)";
         this.cfg.axes.yaxis.renderer = $.jqplot.LinearAxisRenderer;
         //this.cfg.axes.yaxis.ticks = [1,10, 100, 1000];
      }
   </script>

	</h:head>

	<h:body id="body">

		<p:layout fullPage="true" onResize="centerResize()">v
		<p:growl globalOnly="true"/>
			<p:layoutUnit id="top" position="north" size="50">

				<h:form>
					<p:menubar toggleEvent="click">
						<p:menuitem value="&nbsp; Home" url="index.xhtml" icon="fa fa-home"
							styleClass="right-border" />
						<p:menuitem value="&nbsp; Browse Global Trends" url="trends.xhtml"
							icon="fa fa-globe" styleClass="right-border" />
						<p:menuitem value="&nbsp; GO Enrichment" url="enrichment.xhtml"
							icon="fa fa-bar-chart" styleClass="right-border" />
						<p:menuitem value="&nbsp; Tutorial" url="about.xhtml"
							icon="fa fa-question-circle" styleClass="right-border" />
						<p:menuitem value="&nbsp; Documentation" url="documentation.xhtml"
							icon="fa fa-book" styleClass="right-border" />
						<p:menuitem value="&nbsp; Resources" url="resources.xhtml"
							icon="fa fa-info-circle" styleClass="right-border" />
						<f:facet name="options">
							<p:commandButton type="button" icon="fa fa-terminal" onclick="showTerminal()" rendered="#{facesContext.application.projectStage != 'Production'}"/>
							<p:selectOneMenu id="selectspecies"
								value="#{geneSearchView.speciesId}" style="margin-right:5px;">
								<p:ajax event="change" process="@this"/>
								<f:selectItems value="#{cache.speciesList}" var="spec"
									itemValue="#{spec.id}" itemLabel="#{spec.commonName}" />
							</p:selectOneMenu>
							<p:autoComplete id="geneInput" value="#{geneSearchView.query}"
								completeMethod="#{geneSearchView.complete}" queryDelay="600"
								minQueryLength="2" forceSelection="true" maxResults="10"
								label="ID"
								emptyMessage="No gene suggestions available, please try again."
								style="margin-right:8px;"/>
							<p:commandButton type="submit" value="Go"
								action="#{geneSearchView.go}" />
						</f:facet>
					</p:menubar>
				</h:form>
			</p:layoutUnit>

			<p:layoutUnit id="bottom" position="south" size="60">
				<p id="bottom-footer" class="center">
					&copy; UBC, Centre for High-Throughput Biology, 2015 <a
						href="terms.xhtml">Terms and Conditions</a>
				</p>
			</p:layoutUnit>

			<p:layoutUnit id="left" position="west" size="250" resizable="true"
				collapsible="true" header="Options" minSize="250">
				<h:form id="leftForm">
					<h3 class="center">Graph</h3>
					<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
						<h:outputText value="Type: " />
				        <p:selectOneMenu value="#{trackView.graphType}" disabled="#{!(trackView.chartsReady)}">
							<p:ajax listener="#{trackView.reloadGraph}"
								update=":chartForm:chart1,:leftForm" oncomplete="changeGraphScale()"/>
				            <f:selectItem itemLabel="Annotation" itemValue="annotation" />
				            <f:selectItem itemLabel="Jaccard" itemValue="jaccard" />
				            <f:selectItem itemLabel="Multifunctionality" itemValue="multifunctionality" />
				            <f:selectItem itemLabel="Loss / Gain" itemValue="lossgain" />
				        </p:selectOneMenu>


					</h:panelGrid>
					<p:separator style="max-width:200px" />
					<h3 class="center">Data</h3>
					<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
						<h:outputText value="Propagate Annotations: " />
						<p:inputSwitch value="#{trackView.propagate}" disabled="#{!(trackView.chartsReady) || !(trackView.dataEnabled)}">
							<p:ajax listener="#{trackView.reloadGraph}"
								update=":chartForm:chart1" oncomplete="changeGraphScale()"/>
						</p:inputSwitch>

						<h:outputText value="Split Accessions: " />
						<p:inputSwitch value="#{trackView.splitAccessions}" disabled="#{!(trackView.chartsReady) || !(trackView.dataEnabled)}">
							<p:ajax listener="#{trackView.reloadGraph}"
								update=":chartForm:chart1" oncomplete="changeGraphScale()"/>
						</p:inputSwitch>


					</h:panelGrid>
					<p:separator style="max-width:200px" />
					<h3 class="center">Display</h3>
					<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
						<h:outputText value="Scale: " />
						<p:selectOneButton id="scaleSelect" value="#{trackView.scale}" onchange="changeGraphScale()" disabled="#{!(trackView.chartsReady)}">
							<f:selectItem itemLabel="Linear" itemValue="linear" />
							<f:selectItem itemLabel="Log" itemValue="log" />
						</p:selectOneButton>


					</h:panelGrid>
					
					<p:separator style="max-width:200px" />
					<h3 class="center">Filter <p:commandButton actionListener="#{trackView.clearOptionFilters()}" icon="fa fa-trash" update=":chartForm:chart1, :leftForm" oncomplete="changeGraphScale()" styleClass="icon-only" disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}"/></h3>
					<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
						<h:outputText value="Aspect: " />
						<p:selectManyButton id="optionFilterAspect" value="#{trackView.filterAspect}" disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}">
							<p:ajax listener="#{trackView.reloadGraph}"
								update=":chartForm:chart1" oncomplete="changeGraphScale()"/>
								<f:selectItem itemLabel="BP" itemValue="BP" />
								<f:selectItem itemLabel="MF" itemValue="MF" />
								<f:selectItem itemLabel="CC" itemValue="CC" />
							
						</p:selectManyButton>
						
						<h:outputText value="Id: " />
						<p:autoComplete id="optionFilterId" value="#{trackView.filterId}"
								completeMethod="#{trackView.completeId}" queryDelay="600"
								minQueryLength="1" forceSelection="true" maxResults="10"
								label="ID"
								emptyMessage="No term suggestions available."
								disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}">
								<p:ajax event="itemSelect" listener="#{trackView.reloadGraph}" update=":chartForm:chart1" oncomplete="changeGraphScale()"/>
						</p:autoComplete>
						
						<h:outputText value="Name: " />
						<p:inputText id="optionFilterName" value="#{trackView.filterName}" disabled="#{!(trackView.chartsReady) || !(trackView.filterEnabled)}">
								<p:ajax event="change" listener="#{trackView.reloadGraph}" update=":chartForm:chart1" oncomplete="changeGraphScale()"/>
						</p:inputText>
						

					</h:panelGrid>
					
					<p:separator style="max-width:200px; height:5px;" />
					<div align="center" style="margin-top: 20px;">
						<p:commandButton value="&nbsp; Reset" onclick="showAllSeries()" type="button" icon="fa fa-refresh" />
					</div>
				</h:form>


				<f:facet name="footer">
					<h:graphicImage library="img" width="130" height="110"
						name="logo1.png" styleClass="center" />
				</f:facet>
			</p:layoutUnit>

			<p:layoutUnit id="right" position="east" size="550" minSize="300"
				header="Functionality" resizable="true" collapsible="true"
				style="text-align:center">
				<h:form id="funcForm" style="height:100%;">
					<p:dataTable 	id="funcTable" 
									widgetVar="funcTable" 
									var="term"
									value="#{trackView.allTerms}" 
									scrollable="true"
									sortMode="multiple" 
									style="margin-bottom:0"
									emptyMessage="No annotations found with given criteria"
									filteredValue="#{trackView.filteredAllTerms}"
									selectionMode="multiple" 
									selection="#{trackView.selectedTerms}"
									rowKey="#{term.goId}" 
									scrollHeight="100%" 
									rowStyleClass="#{ term.obsolete == 'true' ? 'datatable-red' : null}">
						<p:column filterBy="#{term.goId}" filterMatchMode="contains"
							headerText="Id" width="25%">
							<a href="http://www.ebi.ac.uk/QuickGO/GTerm?id=#{term.goId}"
								target="_blank"><i class="fa fa-external-link fa-sm"
								style="font-size: 0.7em;" /> #{term.goId}</a>
						</p:column>
						<p:column filterBy="#{term.aspect}" filterMatchMode="in"
							headerText="Aspect" width="20%">
							<f:facet name="filter">
								<p:selectCheckboxMenu label="Aspect"
									onchange="PF('funcTable').filter()"
									panelStyleClass="without-selectall">
									<f:selectItems value="#{trackView.aspects}" />
								</p:selectCheckboxMenu>
							</f:facet>
							<h:outputText value="#{term.aspect}" />
						</p:column>
						<p:column filterBy="#{term.name}" filterMatchMode="contains"
							headerText="Name" width="55%">
							<h:outputText value="#{term.name}" />
						</p:column>
						<f:facet name="footer">
							<p:commandButton process="funcTable" icon="ui-icon-search" value="View" onclick="fetchTimelineFromPanel()"
								oncomplete="PF('timelineDialog').show()" />
						</f:facet>
					</p:dataTable>
					
					<p:remoteCommand actionListener="#{trackView.fetchTimelineFromPanel()}"
						name="fetchTimelineFromPanel" update=":timelineForm">
					</p:remoteCommand>

				</h:form>
			</p:layoutUnit>

			<p:layoutUnit id="center" position="center">
			<p:messages for="betaMessage" closable="true" />

				<div id="page-title">
					<h1>#{trackView.currentGene.symbol} -
						#{trackView.currentSpecies.scientificName}</h1>
					<h:form>
						<p>
							<ui:repeat
								value="#{trackView.getCurrentPrimaryAccessionsValues()}"
								var="acc" varStatus="loop">
								<a href="http://www.uniprot.org/uniprot/#{acc.accession}"
									target="_blank">#{acc.accession}</a>#{!loop.last ? ', ' : ''}
				</ui:repeat>
						</p>
					</h:form>
				</div>
				<p:separator style="max-width:400px" />

				<h:form id="chartForm">
					<div id="allChartsDiv">
						<p:outputPanel id="allCharts">
							<div id="loading-spinner" class="loading"></div>
							<p:chart id='chart1' type="line"
								model="#{trackView.currentChart}" style="height:500px;"
								widgetVar="chart" rendered="#{trackView.chartsReady}">
								<p:ajax event="itemSelect" listener="#{trackView.itemSelect}"
									oncomplete="openAnnotationDialog()"/>
							</p:chart>
							<!-- <pe:tooltip value="this is a test" shared="true" for="@(td.jqplot-table-legend-swatch)"/> -->
						</p:outputPanel>
					</div>
					<p:remoteCommand name="fetchCharts"
						actionListener="#{trackView.fetchAll()}"
						update="allCharts,:leftForm,:funcForm:funcTable"
						oncomplete="hideLoadingSpinner()">
					</p:remoteCommand>
					<p:remoteCommand
						oncomplete = "PF('itemSelectDialog').show();"
						update=":itemSelectForm:itemSelectMsg,:itemSelectForm:itemSelectData"
						name="openAnnotationDialog"/>


					<!-- PUT THE ACTUAL CONTENT -->

					<!-- End of the FUNCTIONALITY CONTENT -->
				</h:form>
				
			</p:layoutUnit>

		</p:layout>

		<p:dialog header="Basic Dialog" widgetVar="dlg" modal="true">
			<h:outputText value="Resistance to PrimeFaces is futile!" />
		</p:dialog>
		<p:dialog id="timelineDialog" header="Selected Terms"
			widgetVar="timelineDialog" modal="true" showEffect="fade"
			hideEffect="fade" resizable="false" width="800" max-height="600"
			style="text-align:center;"
			onHide="cleanMsg()">
			<p:ajax event="close" listener="#{trackView.cleanTimeline}" update=":timelineForm" />
			<p:scrollPanel id="timeline-scrollpanel" mode="native" style="max-height:500px">
			<h:outputText id="timelineSelectMsgDate" />
			<p:spacer width="30" height="16" />
			<h:outputText id="timelineSelectMsgTerm" />
			<p:spacer width="30" height="16" />
			<h:outputText id="timelineSelectMsgReference" />


			<h:form id="timelineForm">
				<p:dataGrid id="timelineDataGrid" var="tl"
					value="#{trackView.timelines}" columns="1" style="border:none;" rowIndexVar="rowIndex" widgetVar="timelineDataGridWidget">
					<p:panel style="text-align:center">
			        <f:facet name="header">
			        	<h:outputText value="#{tl.title.goId} - #{of:abbreviate(tl.title.name, 50)}" title="#{tl.title.name}"/>  
			        </f:facet>
					<pe:timeline id="timeline-#{rowIndex}" widgetVar="timelineWidget-#{rowIndex}" value="#{tl}" varGroup="group" selectable="true"
						eventMargin="10" eventMarginAxis="0" stackEvents="false"
						themable="false" showCurrentTime="false">
						<pe:javascript event="select" execute="timelineSelect('#{rowIndex}')" />
						<pe:javascript event="rangechange" execute="onTimelineRangeChange('#{rowIndex}')"/>

					</pe:timeline>
					</p:panel>
				</p:dataGrid>
			</h:form>
			<pe:tooltip global="true" myPosition="center left" atPosition="top right"/>
			</p:scrollPanel>
		</p:dialog>
		<p:dialog id="itemSelectDialog" header="Annotations" widgetVar="itemSelectDialog"
			modal="false" width="700px">
			<p:ajax event="close" listener="#{trackView.cleanFilteredTerms}" update=":itemSelectForm:itemSelectData"/>
			<h:form id="itemSelectForm" >
			<h:outputText id="itemSelectMsg"
				value="Date: #{trackView.selectedDate}, Count: #{trackView.itemSelectValue}" />
			<p:dataTable 	id="itemSelectData" 
							widgetVar="annotationsTable"
							var="chartTerm" 
							value="#{trackView.itemSelectTerms}" 
							scrollable="true"
							scrollHeight="250" 
							sortMode="multiple" 
							style="margin-bottom:0"
							emptyMessage="No annotations found with given criteria"
							filteredValue="#{trackView.filteredTerms}" 
							selectionMode="multiple" 
							selection="#{trackView.itemSelectViewTerms}" 
							rowKey="#{chartTerm.goId}" 
							rowStyleClass="#{ chartTerm.obsolete == 'true' ? 'datatable-red' : null}">
				<p:column filterBy="#{chartTerm.goId}" filterMatchMode="contains"
					headerText="Id" style="width:120px;">
					<a href="http://www.ebi.ac.uk/QuickGO/GTerm?id=#{chartTerm.goId}"
						target="_blank"><i class="fa fa-external-link fa-sm"
						style="font-size: 0.7em;" /> #{chartTerm.goId}</a>
				</p:column>
				<p:column filterBy="#{chartTerm.aspect}" filterMatchMode="in"
					headerText="Aspect" style="width:200px;">
					<f:facet name="filter">
						<p:selectManyButton onchange="PF('annotationsTable').filter()"
							panelStyle="width:200px">
							<f:selectItem itemLabel="BP" itemValue="BP" />
							<f:selectItem itemLabel="MF" itemValue="MF" />
							<f:selectItem itemLabel="CC" itemValue="CC" />
						</p:selectManyButton>
					</f:facet>
					<h:outputText value="Biological Process"
						rendered="#{chartTerm.aspect == 'BP'}" />
					<h:outputText value="Molecular Function"
						rendered="#{chartTerm.aspect == 'MF'}" />
					<h:outputText value="Cellular Component"
						rendered="#{chartTerm.aspect == 'CC'}" />
				</p:column>
				<p:column filterBy="#{chartTerm.name}" filterMatchMode="contains"
					headerText="Name">
					<h:outputText value="#{chartTerm.name}" />
				</p:column>
						<f:facet name="footer">
							<p:commandButton process="itemSelectData" icon="ui-icon-search" value="View" onclick="fetchTimelineFromDialog()"
								oncomplete="PF('timelineDialog').show()" />
						</f:facet>
			</p:dataTable>
			<p:remoteCommand actionListener="#{trackView.fetchTimelineFromDialog()}"
				name="fetchTimelineFromDialog" update=":timelineForm">
			</p:remoteCommand>
			</h:form>
		</p:dialog>
		<p:dialog id="terminalDialog" header="Terminal"
			widgetVar="terminalDialogWdg" modal="false" showEffect="fade"
			hideEffect="fade" resizable="false" width="800px">
			<h:form id="terminalForm">
			    <p:focus for="terminal" />
			 
			    <p:terminal id="terminal" widgetVar="terminalWdg" commandHandler="#{trackView.handleCommand}"
			                welcomeMessage="Welcome to the administrative console, how are you today?" prompt="$" width="100%" height="100%"/>
			
			</h:form>
		</p:dialog>
		



	</h:body>

</f:view>


</html>
