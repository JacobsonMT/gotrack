<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions">

<f:view contentType="text/html">
	<f:metadata>
		<f:viewParam id="currentSpeciesId" name="currentSpeciesId"
			value="#{trackView.currentSpeciesId}" />
		<f:viewParam id="query" name="query" value="#{trackView.query}" />
		<f:event type="preRenderView" listener="#{trackView.init}" />
	</f:metadata>
	<h:head>
		<title>UBC-CHiBi|GOtrack</title>
		<h:outputStylesheet
			name="webjars/font-awesome/4.2.0/css/font-awesome.css" />
		<h:outputStylesheet library="css" name="showcase.css" />
		<h:outputStylesheet library="css" name="custom.css" />
		<h:outputStylesheet library="css" name="track.css" />

		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<!-- Prevents caching at the Proxy Server -->

		<meta http-equiv="Expires" content="0" />
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="description"
			content="GOtrack is an integral tool that reflects the problems and trends in the stability and annotation biases of multiple model organisms." />

		<meta name="keywords"
			content="genomics,bioinformatics,genetics,gene,function,ontology,biotechnology,medicine,biomedical,meta-analysis,statistics,search,open source,database,software" />

		<h:outputScript library="js" name="gotrack.js" />
		<h:outputScript library="js" name="jqplot.logAxisRenderer.js" />
		<script>
      function chartExtender() {
         // this = chart widget instance        
         // this.cfg = options 
         this.cfg.legend = {
            renderer : $.jqplot.EnhancedLegendRenderer,
            show : true,
            location : 'ne',
            placement : 'outsideGrid',
            rendererOptions : {
               numberRows : 0,
               seriesToggle: true,
               seriesToggleReplot : {resetAxes: true}
            }
         }
         this.cfg.highlighter = {
            show : true,
            tooltipLocation : 'sw',
            useAxesFormatters : true,
            tooltipAxes : 'xy',
            yvalues : 1,
            formatString : 'Date: %s ~ Count: %s',
            tooltipContentEditor : function(str, seriesIndex, pointIndex, plot) {
               return plot.series[seriesIndex].label + ": " + str;
            },
            bringSeriesToFront : true

         }
         //console.log(this.cfg.axes);
         //this.cfg.axes.yaxis.label = "Per Capita Expenditure (local currency)";
         this.cfg.axes.yaxis.renderer = $.jqplot.LinearAxisRenderer;

         //this.cfg.axes.yaxis.ticks = [1,10, 100, 1000];
      }
   </script>

	</h:head>

	<h:body>

		<p:layout fullPage="true" onResize="centerResize()">
			<p:layoutUnit id="top" position="north" size="50">

				<h:form>
					<p:menubar toggleEvent="click">
						<p:menuitem value="Home" url="index.xhtml" icon="fa fa-home"
							styleClass="right-border" />
						<p:menuitem value="Browse Global Trends" url="trends.xhtml"
							icon="fa fa-globe" styleClass="right-border" />
						<p:menuitem value="Tutorial" url="about.xhtml"
							icon="fa fa-question-circle" styleClass="right-border" />
						<p:menuitem value="Documentation" url="documentation.xhtml"
							icon="fa fa-book" styleClass="right-border" />
						<p:menuitem value="Resources" url="resources.xhtml"
							icon="fa fa-info-circle" styleClass="right-border" />
						<f:facet name="options">
							<p:selectOneMenu id="selectspecies"
								value="#{indexView.currentSpeciesId}" style="margin-right:5px;">
								<p:ajax event="change" update="selectspecies" />
								<f:selectItems value="#{cache.speciesList}" var="spec"
									itemValue="#{spec.id}" itemLabel="#{spec.commonName}" />
							</p:selectOneMenu>
							<p:autoComplete id="userinp" value="#{indexView.query}"
								completeMethod="#{indexView.complete}" queryDelay="600"
								minQueryLength="2" forceSelection="true" maxResults="10"
								label="ID"
								emptyMessage="No gene suggestions available,  please try again."
								style="margin-right:8px;">
								<p:ajax event="focus" update="selectspecies" />
							</p:autoComplete>
							<p:commandButton type="submit" value="Go"
								action="#{indexView.go}" />
						</f:facet>
					</p:menubar>
				</h:form>
			</p:layoutUnit>

			<p:layoutUnit id="bottom" position="south" size="60">
				<p id="bottom-footer" class="center">
					&copy; UBC, Centre for High-Throughput Biology, 2015 <a
						href="terms.xhtml">Terms and Conditions</a>
				</p>
			</p:layoutUnit>

			<p:layoutUnit id="left" position="west" size="250" resizable="true"
				collapsible="true" header="Options" minSize="250">
				<h:form id="leftForm">
					<h3 class="center">Data</h3>
					<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
						<h:outputText value="Propagate Annotations: " />
						<p:inputSwitch value="#{trackView.propagate}">
							<p:ajax listener="#{trackView.reloadGraph}"
								update=":chartForm:chart1" />
						</p:inputSwitch>

						<h:outputText value="Split Accessions: " />
						<p:inputSwitch value="#{trackView.splitAccessions}">
							<p:ajax listener="#{trackView.reloadGraph}"
								update=":chartForm:chart1" />
						</p:inputSwitch>


					</h:panelGrid>
					<p:separator style="max-width:200px" />
					<h3 class="center">Graph</h3>
					<h:panelGrid columns="2" style="margin-bottom:10px" cellpadding="5">
						<h:outputText value="Scale: " />
						<p:selectOneButton id="scaleSelect" value="#{trackView.scale}"
							onchange="changeGraphScale()">
							<f:selectItem itemLabel="Linear" itemValue="linear" />
							<f:selectItem itemLabel="Log" itemValue="log" />
						</p:selectOneButton>


					</h:panelGrid>
					<p:separator style="max-width:200px; height:5px;" />
					<div align="center" style="margin-top: 20px;">
						<p:commandButton value="&nbsp; Reset" onclick="centerResize()"
							icon="fa fa-refresh" />
					</div>
				</h:form>


				<f:facet name="footer">
					<h:graphicImage library="img" width="130" height="110"
						name="logo1.png" styleClass="center" />
				</f:facet>
			</p:layoutUnit>

			<p:layoutUnit id="right" position="east" size="550" minSize="300"
				header="Functionality" resizable="true" collapsible="true"
				style="text-align:center">
				<h:form id="funcForm">
					<p:dataTable id="funcTable" widgetVar="funcTable" var="term"
						value="#{trackView.allTerms}" scrollable="true"
						sortMode="multiple" style="margin-bottom:0"
						emptyMessage="No annotations found with given criteria"
						filteredValue="#{trackView.filteredAllTerms}"
						selectionMode="multiple" selection="#{trackView.selectedTerms}"
						rowKey="#{term.goId}">
						<p:column filterBy="#{term.goId}" filterMatchMode="contains"
							headerText="Id" width="25%">
							<a href="http://www.ebi.ac.uk/QuickGO/GTerm?id=#{term.goId}"
								target="_blank"><i class="fa fa-external-link fa-sm"
								style="font-size: 0.7em;" /> #{term.goId}</a>
						</p:column>
						<p:column filterBy="#{term.aspect}" filterMatchMode="in"
							headerText="Aspect" width="25%">
							<f:facet name="filter">
								<p:selectCheckboxMenu label="Aspect"
									onchange="PF('funcTable').filter()"
									panelStyleClass="without-selectall">
									<f:selectItems value="#{trackView.aspects}" />
								</p:selectCheckboxMenu>
							</f:facet>
							<h:outputText value="#{term.aspect}" />
						</p:column>
						<p:column filterBy="#{term.name}" filterMatchMode="contains"
							headerText="Name" width="50%">
							<h:outputText value="#{term.name}" />
						</p:column>
						<f:facet name="footer">
							<p:commandButton process="funcTable"
								update=":selectedTermsDetail" icon="ui-icon-search" value="View"
								oncomplete="PF('selectedTermsDialog').show()" />
						</f:facet>
					</p:dataTable>
					<p:remoteCommand actionListener="#{trackView.fetchAllTerms()}"
						name="loadAllTerms" update="funcTable">
					</p:remoteCommand>

				</h:form>
			</p:layoutUnit>

			<p:layoutUnit id="center" position="center">

				<div id="page-title">
					<h1>#{trackView.query} -
						#{trackView.currentSpecies.scientificName}</h1>
					<h:form>
						<p>
							<ui:repeat
								value="#{trackView.getCurrentPrimaryAccessionsValues()}"
								var="acc" varStatus="loop">
								<a href="http://www.uniprot.org/uniprot/#{acc.accession}"
									target="_blank">#{acc.accession}</a>#{!loop.last ? ', ' : ''}
				</ui:repeat>
						</p>
					</h:form>
				</div>
				<p:separator style="max-width:400px" />

				<h:form id="chartForm">
					<div id="allChartsDiv">
						<p:outputPanel id="allCharts">
							<div id="loading-spinner" class="loading"></div>
							<p:chart id='chart1' type="line"
								model="#{trackView.currentChart}" style="height:500px;"
								widgetVar="chart" rendered="#{trackView.chartsReady}">
								<p:ajax event="itemSelect" listener="#{trackView.itemSelect}"
									onsuccess="PF('dlg2').show();"
									update=":dialogMsg,:dialogAnnotations" />
							</p:chart>

						</p:outputPanel>
					</div>
					<p:remoteCommand name="fetchCharts"
						actionListener="#{trackView.fetchDirectChart()}"
						update="allCharts"
						oncomplete="hideLoadingSpinner(), loadAllTerms(), loadPropagated()">
					</p:remoteCommand>
					<p:remoteCommand
						actionListener="#{trackView.fetchPropagatedChart()}"
						name="loadPropagated">
					</p:remoteCommand>


					<!-- PUT THE ACTUAL CONTENT -->

					<!-- End of the FUNCTIONALITY CONTENT -->
				</h:form>


			</p:layoutUnit>

		</p:layout>

		<p:dialog header="Basic Dialog" widgetVar="dlg" modal="true">
			<h:outputText value="Resistance to PrimeFaces is futile!" />
		</p:dialog>
		<p:dialog id="selectedTermsDialog" header="Selected Terms"
			widgetVar="selectedTermsDialog" modal="true" showEffect="fade"
			hideEffect="fade" resizable="false" width="200">
			<p:outputPanel id="selectedTermsDetail" style="text-align:center;">
				<ui:repeat value="#{trackView.selectedTerms}" var="term">
					<h:outputText value="#{term.goId} - #{term.name}"
						style="display:block" />
				</ui:repeat>
			</p:outputPanel>
		</p:dialog>
		<p:dialog id="dlg2" header="Annotations" widgetVar="dlg2"
			modal="false" width="700px">
			<h:outputText id="dialogMsg"
				value="Date: #{trackView.selectedDate}, Count: #{fn:length(trackView.terms)}" />
			<p:dataTable id="dialogAnnotations" widgetVar="annotationsTable"
				var="term" value="#{trackView.terms}" scrollable="true"
				scrollHeight="250" sortMode="multiple" style="margin-bottom:0"
				emptyMessage="No annotations found with given criteria"
				filteredValue="#{trackView.filteredTerms}">
				<p:column filterBy="#{term.goId}" filterMatchMode="contains"
					headerText="Id" style="width:120px;">
					<a href="http://www.ebi.ac.uk/QuickGO/GTerm?id=#{term.goId}"
						target="_blank"><i class="fa fa-external-link fa-sm"
						style="font-size: 0.7em;" /> #{term.goId}</a>
				</p:column>
				<p:column filterBy="#{term.aspect}" filterMatchMode="in"
					headerText="Aspect" style="width:200px;">
					<f:facet name="filter">
						<p:selectManyButton onchange="PF('annotationsTable').filter()"
							panelStyle="width:200px">
							<f:selectItem itemLabel="BP" itemValue="BP" />
							<f:selectItem itemLabel="MF" itemValue="MF" />
							<f:selectItem itemLabel="CC" itemValue="CC" />
						</p:selectManyButton>
					</f:facet>
					<h:outputText value="Biological Process"
						rendered="#{term.aspect == 'BP'}" />
					<h:outputText value="Molecular Function"
						rendered="#{term.aspect == 'MF'}" />
					<h:outputText value="Cellular Component"
						rendered="#{term.aspect == 'CC'}" />
				</p:column>
				<p:column filterBy="#{term.name}" filterMatchMode="contains"
					headerText="Name">
					<h:outputText value="#{term.name}" />
				</p:column>
			</p:dataTable>
		</p:dialog>



	</h:body>

</f:view>


</html>
